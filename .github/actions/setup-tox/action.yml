name: 'Setup tox'
description: 'Install tox and restore cache'
inputs:
  cache-key-suffix:
    description: 'string to append at the end of the cache key'
    required: false
    default: ''
outputs:
  cache-hit:
    description: 'A boolean value to indicate an exact match was found.'
    value: ${{ steps.cache.outputs.cache-hit }}

runs:
  using: 'composite'
  steps:
    - name: Compile requirements
      run: python -m devtools --no-venv repo --no-sync --no-pre-commit-install
      shell: bash
    - name: Install dependencies
      run: pip install tox -c requirements-dev.txt
      shell: bash
    - name: Get python info
      id: python
      run: echo "checksum=$(python -VV | sha256sum | cut -d' ' -f1)" >> $GITHUB_OUTPUT
      shell: bash
    - name: Get tox package info
      id: tox
      run: echo "version=$(pip freeze | grep 'tox==' | awk -F'==' '{print $2}')" >> $GITHUB_OUTPUT
      shell: bash
    - name: Restore tox environment
      id: cache
      uses: actions/cache@v3
      with:
        path: .tox
        key: ${{ runner.os }}|${{ github.workflow }}|${{ github.job }}|tox-${{ steps.tox.outputs.version }}|${{ steps.python.outputs.checksum }}|${{ hashFiles( 'tox.ini' , 'requirements*.txt') }}|${{ inputs.cache-key-suffix }}
